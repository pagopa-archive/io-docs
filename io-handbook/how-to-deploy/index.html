<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">How to deploy | IO Docs</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="How to deploy | IO Docs"><meta data-react-helmet="true" name="description" content="Context"><meta data-react-helmet="true" property="og:description" content="Context"><meta data-react-helmet="true" property="og:url" content="https://pagopa.github.io/io-docs/io-handbook/how-to-deploy"><link data-react-helmet="true" rel="shortcut icon" href="/io-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pagopa.github.io/io-docs/io-handbook/how-to-deploy"><link rel="stylesheet" href="/io-docs/styles.633e5506.css">
<link rel="preload" href="/io-docs/styles.39dbcb21.js" as="script">
<link rel="preload" href="/io-docs/runtime~main.4b14e9f2.js" as="script">
<link rel="preload" href="/io-docs/main.2774e423.js" as="script">
<link rel="preload" href="/io-docs/1.d8df4888.js" as="script">
<link rel="preload" href="/io-docs/2.88ce8145.js" as="script">
<link rel="preload" href="/io-docs/22.54eab700.js" as="script">
<link rel="preload" href="/io-docs/935f2afb.bf11ab24.js" as="script">
<link rel="preload" href="/io-docs/17896441.1ad97a69.js" as="script">
<link rel="preload" href="/io-docs/899ae694.4672fffa.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/io-docs/"><img class="navbar__logo" src="/io-docs/img/logo.svg" alt="IO logo"><strong class="navbar__title">IO Docs</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://io.italia.it" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">IO</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/io-docs/"><img class="navbar__logo" src="/io-docs/img/logo.svg" alt="IO logo"><strong class="navbar__title">IO Docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://io.italia.it" target="_blank" rel="noopener noreferrer" class="menu__link">IO</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/io-docs/">Table of contents</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Handbook</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/index">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/general">General Guidelines</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/how-to">How to use this handbook</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/communication">Communication</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/learning">Learning and knowledge sharing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/who-does-what">Who does what?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/development-workflow">Development workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/development-guidelines">Development guidelines</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/development-styleguide">Development styleguide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/technology-radar">Technology Radar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/cicd-setup">How to setup CI/CD for a project</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/io-docs/io-handbook/how-to-deploy">How to deploy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/typescript-compiler-issues">Typescript compiler issues</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/io-docs/io-handbook/program">Program management</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">How to deploy</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="context"></a>Context<a aria-hidden="true" tabindex="-1" class="hash-link" href="#context" title="Direct link to heading">#</a></h2><p>This guide is intended for all tech team members that need to deploy into production
running the pipelines through the <a href="https://dev.azure.com/pagopa-io/" target="_blank" rel="noopener noreferrer">Azure DevOps</a> portal.</p><p>Ask for permession in #dev_io if you are willing to deploy some artifacts
(ie. backend, functions) into the IO platform production environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="prerequisites"></a>Prerequisites<a aria-hidden="true" tabindex="-1" class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h2><p>Please check the following requirements:</p><ul><li><a href="https://docs.microsoft.com/it-it/cli/azure/install-azure-cli" target="_blank" rel="noopener noreferrer">Azure CLI</a> is installed locally</li><li>You have the permission to run a pipeline on Azure DevOps</li><li>You have access to production services on the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a></li><li>You can create new releases on GitHub</li></ul><p>We are going to take the deployment of <a href="https://github.com/pagopa/io-functions-assets" target="_blank" rel="noopener noreferrer">io-functions-assets</a>
as an example, assuming that we want to deploy a new version of the code in the production environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="lookup-code-changes"></a>Lookup code changes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lookup-code-changes" title="Direct link to heading">#</a></h2><p>The first question you should answer is: <strong>What changes needs to be deployed yet?</strong></p><p>To answer this question we have implemented a Slack command:
run <code>/iodeploy</code> into any Slack channel to see how many changes are waiting to be deployed for your target project
(namely: how many commits have been merged into the <code>master</code> branch since the latest version was released).
For each project you&#x27;ll get a link to the GitHub code diff between the release candidate (HEAD)
and the latest version released.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="run-the-pipeline"></a>Run the pipeline<a aria-hidden="true" tabindex="-1" class="hash-link" href="#run-the-pipeline" title="Direct link to heading">#</a></h2><ol><li>Navigate to the <a href="https://dev.azure.com/pagopa-io/" target="_blank" rel="noopener noreferrer">Azure DevOps</a> portal</li><li>Click on <strong><em>io-functions-assets</em></strong>&#x27; s project</li><li>Go to <strong><em>Pipelines</em></strong> and select the deploy pipeline from list (i.e <em>pagopa.io-functions-assets.deploy</em>)</li><li>Click on <strong><em>Run Pipeline</em></strong> button, you should see a right bar menu <img alt="Run pipeline" src="/io-docs/assets/images/run_pipeline-97c0e530ebcaafef20f4c14e4b2c1f92.png"></li><li>Check the options and value them according to the scenario you are in (see below); when ready, press the <strong><em>Run</em></strong> button</li><li>Monitor the job status on the pipeline jobs detail pages: <img alt="Pipeline status" src="/io-docs/assets/images/pipeline_status-e0934649eb5ff719a5f2a99e7503aaae.png"> <img alt="Pipeline Job check" src="/io-docs/assets/images/Pipeline_status_check-fa28435230b00e1f8b01d302db368be5.png"></li></ol><p>The deploy pipeline is configured to creare a release itself, so no previous operations are needed in order to deploy a new version of the application.</p><p>A common deploy pipeline will look like the following:
<img alt="Pipeline stages" src="/io-docs/assets/images/pipeline_stages_new_release-0a5160d05b45289ae1b97d02663c4505.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="scenario-deploy-new-features"></a>Scenario: deploy new features<a aria-hidden="true" tabindex="-1" class="hash-link" href="#scenario-deploy-new-features" title="Direct link to heading">#</a></h3><p>The most common case: new code is added to <code>master</code> branch and you want to ship it. On the pipeline option screen, do the following:</p><ol><li>Select <code>master</code> as base <code>branch/tag</code></li><li>Choose between <code>major</code>, <code>minor</code> or <code>patch</code> depending on the kind of changes introduced; application version will be bumped accordingly </li><li>Leave stages untouched</li></ol><p>The pipeline will bump the application version, create a new release on project&#x27;s Github page, build and deploy the application using a <em>staging</em> slot to have a warm start.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="scenario-deploy-an-existing-version"></a>Scenario: deploy an existing version<a aria-hidden="true" tabindex="-1" class="hash-link" href="#scenario-deploy-an-existing-version" title="Direct link to heading">#</a></h3><p>This scenario happens when it is needed to roll back the application to a previous version (or you want to retry a failed deploy without creating a new release). On the pipeline option screen, do the following:</p><ol><li>Select <code>refs/tags/v{VERSION}-RELEASE</code> as base <code>branch/tag</code>, where <code>{VERSION}</code> is the semver number to reference code to.</li><li>Ignore the choice between <code>major</code>, <code>minor</code> or <code>patch</code>, as no release will be created.</li><li>Leave stages untouched.</li></ol><p>The <code>Release</code> stage will be executed successufully anyway, but no release will be created. The application is then built and deployrd using a <em>staging</em> slot to have a warm start.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="monitor-production-logs"></a>Monitor production logs<a aria-hidden="true" tabindex="-1" class="hash-link" href="#monitor-production-logs" title="Direct link to heading">#</a></h2><p>While the pipeline is running, and after the code has reached production,
monitor the production logs to lookup any error that may have been caused by the deploy.</p><p>You must be logged in into the <a href="https://portal.azure.com/#home" target="_blank" rel="noopener noreferrer">Azure Portal</a>
and have the right to access Application Insights and the service you&#x27;re deploying to.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="check-the-activity-log"></a>Check the activity log<a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-the-activity-log" title="Direct link to heading">#</a></h3><ol><li>Search for the service you are deploying to (in this case <strong><em>io-p-fn3-assets</em></strong>)</li><li>Select <strong><em>Activity Log</em></strong> and take care about the swap operations (from staging to production)</li></ol><p><img alt="activity Log 1" src="/io-docs/assets/images/activity_log1-9f5a4c287cb3c7e635262ea9caf9650b.png"></p><p><img alt="activity log 2" src="/io-docs/assets/images/activity_log2-4a763922d6ece322cbfdcfcbfefc7b3a.png"></p><p><img alt="activity log 3" src="/io-docs/assets/images/activity_log3-07b22c6b357aa60e3d422d6770c33079.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="check-application-insights-logs"></a>Check Application Insights logs<a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-application-insights-logs" title="Direct link to heading">#</a></h3><ol><li>Search for Application Insights (<strong><em>io-p-ai-common</em></strong>)</li><li>Open the <strong><em>Failures</em></strong> section (left menu) and check if there are error spikes after the slots are swapped (from staging to production)</li></ol><p><img alt="app insights" src="/io-docs/assets/images/app_insights-b68ffda568f9c5eebbedcbd545ba9a76.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="check-the-application-logs"></a>Check the application logs<a aria-hidden="true" tabindex="-1" class="hash-link" href="#check-the-application-logs" title="Direct link to heading">#</a></h4><ol><li>Open a terminal and type <code>az login</code> <img alt="az login" src="/io-docs/assets/images/az-login-5fa9186385901f64dcc8fc77873116f8.png"></li><li>Type <code>az webapp log tail --resource-group io-p-rg-internal --name io-p-fn3-assets</code> and check if there are relevant errors</li></ol><p><img alt="az webapp tail" src="/io-docs/assets/images/az-log-tail-03cfc5e23b517fed1a1cb0cff53accde.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="test-in-production-environment"></a>Test in production environment<a aria-hidden="true" tabindex="-1" class="hash-link" href="#test-in-production-environment" title="Direct link to heading">#</a></h2><p>Once the deploy phase is finished and you are confident that there are no relevant errors in production,
try to make some integration tests against what has been just released (ie. by calling the API directly from Postman or cURL);
aside, check if the other core IO functionalities are still working (ie. manually triggering events using the IO mobile application).</p><p><strong>Congratulations! You have terminated your first deploy in our production environment using Azure pipelines!</strong></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/pagopa/io-docs/edit/main/docs/io-handbook/how-to-deploy.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/io-docs/io-handbook/cicd-setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« How to setup CI/CD for a project</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/io-docs/io-handbook/typescript-compiler-issues"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Typescript compiler issues Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context" class="table-of-contents__link">Context</a></li><li><a href="#prerequisites" class="table-of-contents__link">Prerequisites</a></li><li><a href="#lookup-code-changes" class="table-of-contents__link">Lookup code changes</a></li><li><a href="#run-the-pipeline" class="table-of-contents__link">Run the pipeline</a><ul><li><a href="#scenario-deploy-new-features" class="table-of-contents__link">Scenario: deploy new features</a></li><li><a href="#scenario-deploy-an-existing-version" class="table-of-contents__link">Scenario: deploy an existing version</a></li></ul></li><li><a href="#monitor-production-logs" class="table-of-contents__link">Monitor production logs</a><ul><li><a href="#check-the-activity-log" class="table-of-contents__link">Check the activity log</a></li><li><a href="#check-application-insights-logs" class="table-of-contents__link">Check Application Insights logs</a></li></ul></li><li><a href="#test-in-production-environment" class="table-of-contents__link">Test in production environment</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">IO</h4><ul class="footer__items"><li class="footer__item"><a href="https://io.italia.it" target="_blank" rel="noopener noreferrer" class="footer__link-item">IO project</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 PagoPA S.p.a.</div></div></div></footer></div>
<script src="/io-docs/styles.39dbcb21.js"></script>
<script src="/io-docs/runtime~main.4b14e9f2.js"></script>
<script src="/io-docs/main.2774e423.js"></script>
<script src="/io-docs/1.d8df4888.js"></script>
<script src="/io-docs/2.88ce8145.js"></script>
<script src="/io-docs/22.54eab700.js"></script>
<script src="/io-docs/935f2afb.bf11ab24.js"></script>
<script src="/io-docs/17896441.1ad97a69.js"></script>
<script src="/io-docs/899ae694.4672fffa.js"></script>
</body>
</html>